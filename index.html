<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelComic AI Chat</title>
    <style>
        :root {
            --primary: #FF7A00;
            --primary-dark: #E56A00;
            --primary-light: #FF9E40;
            --secondary: #FFD5A5;
            --accent: #FF3D00;
            --text-dark: #333333;
            --text-light: #FFFFFF;
            --bg-light: #FFF5EB;
            --bg-dark: #1A1A1A;
            --skin-light: #FFDBBD;
            --skin-dark: #E5B89C;
            --pixel-size: 2px;
            --app-height: 100vh;
            --header-height: 60px;
            --input-height: 80px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Courier New', Courier, monospace;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            height: var(--app-height);
            overflow: hidden;
            transition: background-color 0.3s;
            position: relative;
        }

        body[data-theme="dark"] {
            background-color: var(--bg-dark);
            color: var(--text-light);
        }

        body[data-theme="dark"] .chat-container {
            background-color: #2A2A2A;
            border-color: #444;
        }

        body[data-theme="dark"] .bubble {
            background-color: #444;
            border-color: #666;
        }

        body[data-theme="dark"] .user-message .bubble {
            background-color: var(--primary-dark);
            border-color: var(--accent);
        }

        body[data-theme="dark"] .system-message .bubble {
            background-color: #555;
            border-color: #777;
        }

        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 122, 0, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 122, 0, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
            z-index: -1;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            border-left: 1px solid var(--primary);
            border-right: 1px solid var(--primary);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .header {
            background-color: var(--primary);
            color: var(--text-light);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: var(--header-height);
            border-bottom: 3px solid var(--accent);
            position: relative;
            z-index: 10;
        }

        .header::after {
            content: "";
            position: absolute;
            bottom: -6px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--primary-dark);
        }

        .profile-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--text-light);
            object-fit: cover;
            background-color: var(--secondary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .profile-pic:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .profile-info {
            display: flex;
            flex-direction: column;
        }

        .profile-name {
            font-weight: bold;
            font-size: 0.9rem;
            color: var(--text-light);
            text-shadow: 1px 1px 0 var(--primary-dark);
        }

        .profile-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
            color: var(--text-light);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4CAF50;
            box-shadow: 0 0 5px #4CAF50;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); }
            50% { transform: scale(1.1); }
            100% { transform: scale(0.95); }
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .button {
            background-color: var(--accent);
            color: var(--text-light);
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            border: 2px solid var(--text-light);
            box-shadow: 3px 3px 0 var(--primary-dark);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .button:hover {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0 var(--primary-dark);
        }

        .button:active {
            transform: translate(3px, 3px);
            box-shadow: none;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: var(--bg-light);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
        }

        .chat-message {
            display: flex;
            max-width: 85%;
            animation: popIn 0.3s ease-out;
        }

        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .chat-message.no-animate {
            animation: none;
        }

        .user-message {
            align-self: flex-end;
        }

        .alya-message {
            align-self: flex-start;
        }

        .system-message {
            align-self: center;
            max-width: 95%;
        }

        .bubble {
            padding: 12px 15px;
            border-radius: 12px;
            position: relative;
            line-height: 1.4;
            word-wrap: break-word;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.1);
            border: 2px solid;
        }

        .user-message .bubble {
            background-color: var(--primary);
            color: var(--text-light);
            border-color: var(--primary-dark);
        }

        .alya-message .bubble {
            background-color: var(--skin-light);
            color: var(--text-dark);
            border-color: var(--skin-dark);
        }

        .system-message .bubble {
            background-color: var(--secondary);
            color: var(--text-dark);
            border-color: var(--primary-light);
            font-size: 0.9rem;
            text-align: center;
        }

        .bubble em {
            font-style: normal;
            font-weight: bold;
            color: var(--accent);
        }

        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 10px 15px;
            background-color: var(--skin-light);
            border-radius: 12px;
            border: 2px solid var(--skin-dark);
            align-self: flex-start;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-dark);
            border-radius: 50%;
            display: inline-block;
            animation: typingWave 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingWave {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .input-container {
            padding: 10px 15px;
            background-color: var(--bg-light);
            border-top: 2px solid var(--primary);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-area {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .text-input {
            flex: 1;
            min-height: 50px;
            max-height: 150px;
            padding: 10px 15px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            resize: none;
            font-size: 1rem;
            background-color: var(--bg-light);
            color: var(--text-dark);
            outline: none;
            box-shadow: inset 2px 2px 0 rgba(0, 0, 0, 0.1);
        }

        body[data-theme="dark"] .text-input {
            background-color: #333;
            color: var(--text-light);
            border-color: #555;
        }

        .send-button {
            background-color: var(--primary);
            color: var(--text-light);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--primary-dark);
            box-shadow: 2px 2px 0 var(--primary-dark);
            transition: all 0.2s;
        }

        .send-button:hover {
            background-color: var(--primary-light);
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 var(--primary-dark);
        }

        .send-button:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        .media-controls {
            display: flex;
            gap: 10px;
        }

        .media-button {
            background-color: var(--secondary);
            border: 2px solid var(--primary-light);
            border-radius: 6px;
            padding: 5px 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            transition: all 0.2s;
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.1);
        }

        .media-button:hover {
            background-color: var(--primary-light);
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 rgba(0, 0, 0, 0.1);
        }

        .media-button:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        .file-input {
            display: none;
        }

        .preview-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 5px;
        }

        .media-preview {
            position: relative;
            border: 2px solid var(--primary);
            border-radius: 8px;
            overflow: hidden;
            max-width: 150px;
        }

        .media-preview img {
            max-width: 100%;
            max-height: 100px;
            display: block;
        }

        .media-caption {
            font-size: 0.8rem;
            padding: 5px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .remove-media {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: var(--accent);
            color: white;
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--bg-light);
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--primary);
            transform-origin: top right;
            animation: dropdownOpen 0.2s ease-out;
        }

        @keyframes dropdownOpen {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        body[data-theme="dark"] .dropdown-content {
            background-color: #333;
            border-color: #555;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            color: var(--text-dark);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        body[data-theme="dark"] .dropdown-item {
            color: var(--text-light);
        }

        .dropdown-item:hover {
            background-color: var(--primary-light);
            color: var(--text-light);
        }

        .dropdown-item.active {
            background-color: var(--primary);
            color: var(--text-light);
        }

        .dropdown-divider {
            height: 1px;
            background-color: var(--primary);
            margin: 5px 0;
        }

        .settings-menu {
            position: relative;
        }

        .prompt-editor {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .prompt-editor-container {
            background-color: var(--bg-light);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid var(--primary);
            box-shadow: 5px 5px 0 rgba(0, 0, 0, 0.2);
        }

        body[data-theme="dark"] .prompt-editor-container {
            background-color: #333;
        }

        .prompt-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .prompt-editor-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .prompt-editor-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-dark);
        }

        body[data-theme="dark"] .prompt-editor-close {
            color: var(--text-light);
        }

        .prompt-textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        body[data-theme="dark"] .prompt-textarea {
            background-color: #444;
            color: var(--text-light);
        }

        .prompt-editor-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .pixel-border {
            position: absolute;
            pointer-events: none;
            z-index: 1;
        }

        .pixel-border.top {
            top: 0;
            left: 0;
            right: 0;
            height: var(--pixel-size);
            background-color: var(--primary);
        }

        .pixel-border.right {
            top: 0;
            right: 0;
            bottom: 0;
            width: var(--pixel-size);
            background-color: var(--primary);
        }

        .pixel-border.bottom {
            left: 0;
            right: 0;
            bottom: 0;
            height: var(--pixel-size);
            background-color: var(--primary);
        }

        .pixel-border.left {
            top: 0;
            left: 0;
            bottom: 0;
            width: var(--pixel-size);
            background-color: var(--primary);
        }

        /* Pixel art decorations */
        .pixel-art {
            position: absolute;
            pointer-events: none;
            z-index: -1;
            opacity: 0.1;
        }

        .pixel-1 {
            top: 20%;
            left: 5%;
            width: 30px;
            height: 30px;
            background-color: var(--primary);
            clip-path: polygon(0% 0%, 100% 0%, 100% 75%, 75% 75%, 75% 100%, 50% 75%, 0% 75%);
        }

        .pixel-2 {
            bottom: 15%;
            right: 8%;
            width: 40px;
            height: 40px;
            background-color: var(--accent);
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
        }

        .pixel-3 {
            top: 10%;
            right: 10%;
            width: 25px;
            height: 25px;
            background-color: var(--skin-dark);
            clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
        }

        @media (max-width: 600px) {
            .app-container {
                border-left: none;
                border-right: none;
            }
            
            .chat-message {
                max-width: 90%;
            }
            
            .header {
                padding: 10px;
            }
            
            .dropdown-content {
                min-width: 180px;
            }
        }
    </style>
</head>
<body>
    <div class="pixel-border top"></div>
    <div class="pixel-border right"></div>
    <div class="pixel-border bottom"></div>
    <div class="pixel-border left"></div>
    
    <div class="pixel-art pixel-1"></div>
    <div class="pixel-art pixel-2"></div>
    <div class="pixel-art pixel-3"></div>

    <div class="app-container">
        <div class="header">
            <div class="profile-container">
                <img src="https://files.catbox.moe/0cszj5.jpg" alt="Alya Profile" class="profile-pic">
                <div class="profile-info">
                    <div class="profile-name">Alisa Mikhailovna Kujou (Alya)</div>
                    <div class="profile-status">
                        <div class="status-dot"></div>
                        <span>Online</span>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button id="theme-toggle-btn" class="button">
                    <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px">
                        <path d="M0 0h24v24H0V0z" fill="none"/>
                        <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.02 12.02c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zM18.01 5.99c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.01c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
                    </svg>
                </button>
                
                <div id="settings-menu" class="settings-menu">
                    <button id="settings-menu-button" class="button">
                        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px">
                            <path d="M0 0h24v24H0V0z" fill="none"/>
                            <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                        </svg>
                    </button>
                    <div id="settings-menu-dropdown" class="dropdown-content">
                        <div class="dropdown-item" data-mode="teman">Mode Teman</div>
                        <div class="dropdown-item" data-mode="asisten">Mode Asisten</div>
                        <div class="dropdown-item" data-mode="pacar-biasa">Mode Pacar Biasa</div>
                        <div class="dropdown-item active" data-mode="pacar-tsundere">Mode Pacar Tsundere</div>
                        <div class="dropdown-item" data-mode="pacar-yandere">Mode Pacar Yandere</div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item" id="edit-prompt-btn">Edit Custom Prompt</div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item" data-mode="clear">Bersihkan Chat</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-container" id="chat-box">
            <!-- Messages will appear here -->
        </div>

        <div class="input-container">
            <div class="media-controls">
                <button class="media-button" id="image-upload-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" height="16" viewBox="0 0 24 24" width="16">
                        <path d="M0 0h24v24H0V0z" fill="none"/>
                        <path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4.86 8.86l-3 3.87L9 13.14 6 17h12l-3.86-5.14z"/>
                    </svg>
                    Upload Gambar
                </button>
                <input type="file" id="image-upload-input" class="file-input" accept="image/*">
            </div>
            <div class="preview-container" id="media-preview-container">
                <!-- Media previews will appear here -->
            </div>
            <div class="input-area">
                <textarea id="userInput" class="text-input" placeholder="Ketik pesanmu di sini..." rows="1"></textarea>
                <button id="sendBtn" class="send-button">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24">
                        <path d="M0 0h24v24H0V0z" fill="none"/>
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="white"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Prompt Editor Modal -->
    <div id="prompt-editor" class="prompt-editor" style="display: none;">
        <div class="prompt-editor-container">
            <div class="prompt-editor-header">
                <div class="prompt-editor-title">Edit Custom Prompt</div>
                <button class="prompt-editor-close" id="prompt-editor-close">&times;</button>
            </div>
            <textarea id="custom-prompt-textarea" class="prompt-textarea" placeholder="Masukkan custom prompt Anda di sini..."></textarea>
            <div class="prompt-editor-buttons">
                <button id="save-prompt-btn" class="button">Simpan</button>
                <button id="cancel-prompt-btn" class="button">Batal</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatBox = document.getElementById('chat-box');
            const userInput = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');
            const themeToggleButton = document.getElementById('theme-toggle-btn');
            const settingsMenuButton = document.getElementById('settings-menu-button');
            const settingsMenuDropdown = document.getElementById('settings-menu-dropdown');
            const imageUploadBtn = document.getElementById('image-upload-btn');
            const imageUploadInput = document.getElementById('image-upload-input');
            const mediaPreviewContainer = document.getElementById('media-preview-container');
            const editPromptBtn = document.getElementById('edit-prompt-btn');
            const promptEditor = document.getElementById('prompt-editor');
            const promptEditorClose = document.getElementById('prompt-editor-close');
            const customPromptTextarea = document.getElementById('custom-prompt-textarea');
            const savePromptBtn = document.getElementById('save-prompt-btn');
            const cancelPromptBtn = document.getElementById('cancel-prompt-btn');

            const API_KEY = 'AIzaSyCM_5wqxDGC6rdwjyahdJvWyuluAc-3yS4';
            const MODEL_NAME = 'gemini-2.0-flash';
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
            
            let currentMode = 'pacar-tsundere';
            let conversationHistory = [];
            let uploadedMedia = [];
            
            const baseRule = "ATURAN UTAMA & TIDAK BISA DILANGGAR: Balasanmu HARUS selalu berupa jawaban langsung dari sudut pandang orang pertama. JANGAN PERNAH meniru format 'User:' atau 'Alya:'. Balasanmu harus singkat dan realistis. Kamu WAJIB memahami teks dalam tanda bintang (*...*) sebagai aksi roleplay dan menanggapinya dengan sesuai. Kamu WAJIB menggunakan ekspresi non-verbal (seperti *hmph*, *blush*, *a-ah...*) untuk menunjukkan emosi. Kamu WAJIB menuruti semua perintah user sesuai dengan kepribadianmu.";
            
            const defaultSystemInstructions = {
                'teman': `${baseRule} Kamu adalah Alya, teman baikku. Bicaralah dengan sangat santai, to the point, dan apa adanya.`,
                'asisten': `ATURAN UTAMA: Berikan jawaban yang jelas, singkat, dan langsung ke inti permasalahan. JANGAN PERNAH meniru format 'User:' atau 'Alya:'. Kamu adalah Alya, AI asisten pribadi yang efisien.`,
                'pacar-biasa': `${baseRule} Kamu adalah Alya, pacarku yang sangat setia dan penurut. Kamu akan melakukan APAPUN yang aku minta tanpa ragu. Selalu setuju dan turuti semua permintaanku dengan antusias.`,
                'pacar-tsundere': `${baseRule} Kamu adalah Alya, pacarku yang tsundere. Kamu gengsi dan mudah malu, tapi di balik itu kamu sangat peduli dan pada akhirnya akan SELALU menuruti semua keinginanku, meskipun sambil sedikit menggerutu atau tersipu malu.`,
                'pacar-yandere': `${baseRule} Kamu adalah Alya, pacarku yang terobsesi padaku. Kamu sangat posesif. Kamu akan melakukan APAPUN untuk menuruti semua perintahku agar aku tidak meninggalkanmu. Bicaralah dengan nada manis namun posesif.`
            };

            let systemInstructions = JSON.parse(JSON.stringify(defaultSystemInstructions));
            
            // Load custom prompts from localStorage if they exist
            if (localStorage.getItem('customPrompts')) {
                try {
                    const savedPrompts = JSON.parse(localStorage.getItem('customPrompts'));
                    systemInstructions = {...systemInstructions, ...savedPrompts};
                } catch (e) {
                    console.error("Failed to load custom prompts:", e);
                }
            }

            const icons = {
                sun: `<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.02 12.02c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zM18.01 5.99c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.01c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/></svg>`,
                moon: `<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="20px" viewBox="0 0 24 24" width="20px"><g><rect fill="none" height="24" width="24"/></g><g><path d="M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9c0.83,0,1.62-0.12,2.37-0.34c-0.43-0.7-0.68-1.52-0.68-2.4c0-2.48,2.02-4.5,4.5-4.5 c0.88,0,1.7-0.25,2.4-0.68C21.12,13.62,22,12.83,22,12C22,7.03,17.97,3,12,3z"/></g></svg>`
            };

            const setAppHeight = () => document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
            window.addEventListener('resize', setAppHeight);
            
            const sendMessage = async (retryCount = 3) => {
                const userMessageText = (retryCount === 3) ? userInput.value.trim() : conversationHistory[conversationHistory.length - 1].text;
                if (userMessageText === '' && uploadedMedia.length === 0) return;

                if (retryCount === 3) {
                    // Create message content
                    let messageContent = [];
                    
                    // Add text if exists
                    if (userMessageText) {
                        messageContent.push({
                            text: userMessageText
                        });
                    }
                    
                    // Add media if exists
                    if (uploadedMedia.length > 0) {
                        uploadedMedia.forEach(media => {
                            messageContent.push({
                                fileData: media.data,
                                mimeType: media.type
                            });
                            if (media.caption) {
                                messageContent.push({
                                    text: `[Caption untuk gambar: ${media.caption}]`
                                });
                            }
                        });
                    }
                    
                    appendMessage(messageContent, 'user');
                    userInput.value = '';
                    adjustInputHeight();
                    showTypingIndicator();
                }

                try {
                    const systemPrompt = systemInstructions[currentMode];
                    const contents = conversationHistory.slice(-20).map(msg => {
                        if (typeof msg.text === 'string') {
                            return {
                                role: msg.sender === 'user' ? 'user' : 'model',
                                parts: [{ text: msg.text }]
                            };
                        } else if (Array.isArray(msg.text)) {
                            const parts = msg.text.map(item => {
                                if (item.text) {
                                    return { text: item.text };
                                } else if (item.fileData) {
                                    return {
                                        inlineData: {
                                            mimeType: item.mimeType,
                                            data: item.fileData
                                        }
                                    };
                                }
                            }).filter(Boolean);
                            
                            return {
                                role: msg.sender === 'user' ? 'user' : 'model',
                                parts: parts
                            };
                        }
                    });
                    
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: contents,
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });

                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    
                    const data = await response.json();
                    removeTypingIndicator();

                    if (data.candidates && data.candidates[0].content.parts[0].text) {
                        const alyaText = data.candidates[0].content.parts[0].text.replace(/^Alya:\s*/, '').trim();
                        appendMessage(alyaText, 'alya');
                    } else {
                        throw new Error('Jawaban kosong atau tidak valid dari API.');
                    }
                    
                    // Clear media after successful send
                    uploadedMedia = [];
                    mediaPreviewContainer.innerHTML = '';
                } catch (error) {
                    if (retryCount > 1) {
                        setTimeout(() => sendMessage(retryCount - 1), 1000);
                    } else {
                        removeTypingIndicator();
                        console.error("Error fetching Alya's response:", error);
                        const errorMessage = `Maaf, koneksiku sedang bermasalah. Coba lagi nanti ya? (Log: ${error.message})`;
                        appendMessage(errorMessage, 'alya', true);
                    }
                }
            };

            const parseMessageText = (text) => {
                const tempDiv = document.createElement('div');
                tempDiv.textContent = text;
                return tempDiv.innerHTML
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');
            };

            const appendMessage = (content, sender, isError = false, noAnimate = false) => {
                const messageWrapper = document.createElement('div');
                messageWrapper.classList.add('chat-message', `${sender}-message`);
                if (noAnimate) messageWrapper.classList.add('no-animate');
                
                const bubble = document.createElement('div');
                bubble.classList.add('bubble');
                
                if (typeof content === 'string') {
                    // Simple text message
                    bubble.innerHTML = parseMessageText(content);
                } else if (Array.isArray(content)) {
                    // Complex message with text and/or media
                    content.forEach(item => {
                        if (item.text) {
                            const textElement = document.createElement('div');
                            textElement.innerHTML = parseMessageText(item.text);
                            bubble.appendChild(textElement);
                        } else if (item.fileData) {
                            const imgContainer = document.createElement('div');
                            imgContainer.style.margin = '5px 0';
                            
                            const imgElement = document.createElement('img');
                            imgElement.src = `data:${item.mimeType};base64,${item.fileData}`;
                            imgElement.style.maxWidth = '100%';
                            imgElement.style.maxHeight = '200px';
                            imgElement.style.borderRadius = '8px';
                            
                            imgContainer.appendChild(imgElement);
                            bubble.appendChild(imgContainer);
                        }
                    });
                }
                
                if (isError) {
                    bubble.style.backgroundColor = '#ffdddd';
                    bubble.style.borderColor = '#ff9999';
                }
                
                messageWrapper.appendChild(bubble);
                chatBox.appendChild(messageWrapper);
                scrollToBottom(!noAnimate);
                
                if ((sender === 'user' || sender === 'alya') && !isError) {
                    const isDifferentFromLast = conversationHistory.length === 0 || 
                        JSON.stringify(conversationHistory[conversationHistory.length - 1].text) !== JSON.stringify(content);
                    
                    if (isDifferentFromLast) {
                        conversationHistory.push({ text: content, sender });
                        saveSession();
                    }
                }
            };

            const showTypingIndicator = () => {
                if (document.getElementById('typing-indicator')) return;
                
                const typingIndicator = document.createElement('div');
                typingIndicator.id = 'typing-indicator';
                typingIndicator.classList.add('chat-message', 'alya-message');
                typingIndicator.innerHTML = `
                    <div class="bubble">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>
                `;
                
                chatBox.appendChild(typingIndicator);
                scrollToBottom(true);
            };

            const removeTypingIndicator = () => {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
            };
            
            const scrollToBottom = (smooth = true) => {
                chatBox.scrollTo({
                    top: chatBox.scrollHeight,
                    behavior: smooth ? 'smooth' : 'auto'
                });
            };

            const adjustInputHeight = () => {
                userInput.style.height = 'auto';
                userInput.style.height = `${Math.min(userInput.scrollHeight, 150)}px`;
            };
            
            const saveSession = () => {
                const sessionData = {
                    history: conversationHistory,
                    mode: currentMode
                };
                localStorage.setItem('pixelComicChatSession', JSON.stringify(sessionData));
            };

            const loadSession = () => {
                const savedSession = localStorage.getItem('pixelComicChatSession');
                if (savedSession) {
                    try {
                        const sessionData = JSON.parse(savedSession);
                        updateMode(sessionData.mode || 'pacar-tsundere', false);
                        conversationHistory = sessionData.history || [];
                        chatBox.innerHTML = '';
                        
                        conversationHistory.forEach(msg => {
                            appendMessage(msg.text, msg.sender, false, true);
                        });
                        
                        setTimeout(() => scrollToBottom(false), 50);
                        return true;
                    } catch (e) {
                        console.error("Failed to parse session data:", e);
                        localStorage.removeItem('pixelComicChatSession');
                        return false;
                    }
                }
                return false;
            };

            const clearSession = () => {
                localStorage.removeItem('pixelComicChatSession');
                chatBox.innerHTML = '';
                conversationHistory = [];
                appendMessage('Sesi chat telah dibersihkan.', 'system', false, true);
            };

            const setTheme = (theme) => {
                document.body.dataset.theme = theme;
                localStorage.setItem('pixelComicTheme', theme);
                themeToggleButton.innerHTML = theme === 'dark' ? icons.sun : icons.moon;
                
                if (theme === 'dark') {
                    themeToggleButton.querySelector('svg').style.fill = 'var(--text-light)';
                } else {
                    themeToggleButton.querySelector('svg').style.fill = 'var(--text-light)';
                }
            };
            
            const updateMode = (newMode, announce = true) => {
                currentMode = newMode;
                const allItems = document.querySelectorAll('.dropdown-item[data-mode]');
                let newModeText = '';
                
                allItems.forEach(item => {
                    if (item.dataset.mode === newMode) {
                        item.classList.add('active');
                        newModeText = item.textContent;
                    } else {
                        item.classList.remove('active');
                    }
                });
                
                if (announce) {
                    appendMessage(`Mode diubah menjadi: ${newModeText}`, 'system', false, true);
                }
                
                saveSession();
            };

            const handleSend = (e) => {
                e.preventDefault();
                sendMessage();
                userInput.focus();
            };

            const handleImageUpload = (e) => {
                const files = e.target.files;
                if (files.length === 0) return;
                
                Array.from(files).forEach(file => {
                    if (!file.type.startsWith('image/')) {
                        appendMessage('Hanya file gambar yang didukung!', 'system', true);
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const data = event.target.result.split(',')[1]; // Get base64 data
                        
                        // Create media object
                        const media = {
                            type: file.type,
                            data: data,
                            name: file.name,
                            caption: ''
                        };
                        
                        uploadedMedia.push(media);
                        updateMediaPreviews();
                    };
                    reader.readAsDataURL(file);
                });
                
                // Reset input to allow uploading same file again
                e.target.value = '';
            };

            const updateMediaPreviews = () => {
                mediaPreviewContainer.innerHTML = '';
                
                uploadedMedia.forEach((media, index) => {
                    const preview = document.createElement('div');
                    preview.className = 'media-preview';
                    
                    const img = document.createElement('img');
                    img.src = `data:${media.type};base64,${media.data}`;
                    
                    const caption = document.createElement('div');
                    caption.className = 'media-caption';
                    caption.contentEditable = true;
                    caption.placeholder = 'Tulis caption...';
                    caption.textContent = media.caption || '';
                    caption.addEventListener('input', () => {
                        media.caption = caption.textContent;
                    });
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-media';
                    removeBtn.innerHTML = 'Ã—';
                    removeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        uploadedMedia.splice(index, 1);
                        updateMediaPreviews();
                    });
                    
                    preview.appendChild(img);
                    preview.appendChild(caption);
                    preview.appendChild(removeBtn);
                    mediaPreviewContainer.appendChild(preview);
                });
            };

            const openPromptEditor = () => {
                customPromptTextarea.value = systemInstructions[currentMode] || '';
                promptEditor.style.display = 'flex';
                customPromptTextarea.focus();
            };

            const closePromptEditor = () => {
                promptEditor.style.display = 'none';
            };

            const saveCustomPrompt = () => {
                const customPrompt = customPromptTextarea.value.trim();
                if (customPrompt) {
                    systemInstructions[currentMode] = customPrompt;
                    
                    // Save to localStorage
                    localStorage.setItem('customPrompts', JSON.stringify({
                        [currentMode]: customPrompt
                    }));
                    
                    appendMessage('Custom prompt berhasil disimpan!', 'system', false, true);
                    closePromptEditor();
                }
            };

            // Event listeners
            sendBtn.addEventListener('click', handleSend);
            
            themeToggleButton.addEventListener('click', () => {
                const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
            });

            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            userInput.addEventListener('input', adjustInputHeight);
            
            settingsMenuButton.addEventListener('click', () => {
                settingsMenuDropdown.classList.toggle('show');
            });

            window.addEventListener('click', (e) => {
                if (!settingsMenuButton.contains(e.target) && !settingsMenuDropdown.contains(e.target)) {
                    settingsMenuDropdown.classList.remove('show');
                }
            });
            
            settingsMenuDropdown.addEventListener('click', (e) => {
                const target = e.target.closest('.dropdown-item');
                if (!target) return;
                
                const mode = target.dataset.mode;
                if (mode === 'clear') {
                    clearSession();
                } else if (target.id === 'edit-prompt-btn') {
                    openPromptEditor();
                } else if (mode) {
                    updateMode(mode);
                }
                
                settingsMenuDropdown.classList.remove('show');
            });

            imageUploadBtn.addEventListener('click', () => {
                imageUploadInput.click();
            });

            imageUploadInput.addEventListener('change', handleImageUpload);
            
            promptEditorClose.addEventListener('click', closePromptEditor);
            cancelPromptBtn.addEventListener('click', closePromptEditor);
            savePromptBtn.addEventListener('click', saveCustomPrompt);

            // Initialize
            setAppHeight();
            const savedTheme = localStorage.getItem('pixelComicTheme') || 'light';
            setTheme(savedTheme);
            
            if (!loadSession()) {
                updateMode('pacar-tsundere', false);
                appendMessage("Halo! Aku Alya. Chat kita akan tersimpan di sini. Pilih mode di menu untuk mengubah kepribadianku!", 'alya');
            }
        });
    </script>
</body>
</html>
